AWSTemplateFormatVersion: '2010-09-09'
Description: Deploy AWS Industrial Time Series Data Connector Quick Start into new
  VPC. **WARNING** You will be billed for the AWS resources used if you create a stack
  from this template.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network Configuration
        Parameters:
          - RemoteAccessCIDR
          - VPCDefinition
          - AvailabilityZones
          - KeyName
      - Label:
          default: Kepware connection configuration
        Parameters:
          - KepWareKeysS3BucketName
          - KepWareCertS3KeyName
          - KepWarePrivateKeyS3KeyName
          - KepWareIP
          - KepWarePort
          - KepWareUsername
          - KepWarePassword

      - Label:
          default: Connector Agent Configuration
        Parameters:
          - LogGroupNamePrefix
          - MetricNamespaceNamePrefix

      - Label:
          default: Management Console Configuration
        Parameters:
          - ApplicationUser
          - ApplicationPassword

      - Label:
          default: ECS cluster configuration
        Parameters:
          - ECSClusterSize
          - ECSInstanceType

      - Label:
          default: RDS Configuration
        Parameters:
          - RDSUsername
          - RDSPassword
          - RDSInstanceType

      - Label:
          default: Connector Supporting Infrastructure Configuration
        Parameters:
          - DataTransportService

      - Label:
          default: Kinesis Configuration
        Parameters:
          - KinesisStreamsShardsCount

      - Label:
          default: IoT Configuration
        Parameters:
          - IoTMetricNamespacePrefix
          - IoTCreateIndividualLogs

      - Label:
          default: Elasticsearch Configuration
        Parameters:
          - MaxIndexAge
          - ElasticsearchNodeCount
          - ElasticsearchNodeType
          - ElasticsearchVolumeSize

      - Label:
          default: S3 Lifecycle Management
        Parameters:
          - EnableS3LifecycleRules
          - IATransitionPeriodInDays
          - GlacierTransitionPeriodInDays

      - Label:
          default: Docker Images Configuration
        Parameters:
          - UseCustomDockerRepository
          - KepWareConnectorDockerTag
          - ApiInstanceDockerTag
          - ManagementConsoleDockerTag
          - MosquittoBrokerDockerTag

      - Label:
          default: AWS Quick Start Configuration
        Parameters:
          - QSS3BucketName
          - QSS3KeyPrefix
          - QSDeploymentSuffix
    ParameterLabels:
      ApplicationPassword:
        default: Management Console Password
      ApplicationUser:
        default: Management Console User Name
      AvailabilityZones:
        default: Availability Zones
      DataTransportService:
        default: Data transport service
      ECSClusterSize:
        default: Number of instances in ECS cluster
      ECSInstanceType:
        default: Type of instances in ECS cluster
      ElasticsearchNodeCount:
        default: Elasticsearch Node Count
      ElasticsearchNodeType:
        default: Elasticsearch Node Type
      ElasticsearchVolumeSize:
        default: Size of EBS volume in GB
      EnableS3LifecycleRules:
        default: Enable S3 Lifecycle
      GlacierTransitionPeriodInDays:
        default: Glacier Transition Period
      IATransitionPeriodInDays:
        default: IA Transition Period
      KeyName:
        default: Key Name
      KinesisStreamsShardsCount:
        default: Kinesis Streams Shards Count
      LogGroupNamePrefix:
        default: Log Group Name Prefix
      MaxIndexAge:
        default: Days to Live
      MetricNamespaceNamePrefix:
        default: Metric Namespace Name Prefix
      IoTMetricNamespacePrefix:
        default: IoT metric namespace
      IoTCreateIndividualLogs:
        default: IoT separate monitoring per feed
      KepWareKeysS3BucketName:
        default: KepWare Certificates Bucket Name
      KepWareCertS3KeyName:
        default: Certificate File S3 Key Name
      KepWarePrivateKeyS3KeyName:
        default: KepWare Private Key S3 File Name
      KepWareIP:
        default: KepServerEX IP address
      KepWarePort:
        default: KepServerEX Port
      KepWareUsername:
        default: KepServerEX Username
      KepWarePassword:
        default: KepServerEX Password
      QSDeploymentSuffix:
        default: Quick Start Deployment Suffix
      QSS3BucketName:
        default: Quick Start S3 Bucket Name
      QSS3KeyPrefix:
        default: Quick Start S3 Key Prefix
      RemoteAccessCIDR:
        default: Remote Access CIDR
      VPCDefinition:
        default: VPC Definition
      RDSInstanceType:
        default: RDS Instance Type
      RDSPassword:
        default: RDS Password
      RDSUsername:
        default: RDS User Name
      ApiInstanceDockerTag:
        default: Docker Tag for API Endpoint
      ManagementConsoleDockerTag:
        default: Docker Tag for Management Console
      MosquittoBrokerDockerTag:
        default: Docker Tag for Mosquitto Broker
      UseCustomDockerRepository:
        default: Use Custom Docker Registry
      KepWareConnectorDockerTag:
        default: Docker Tag for KepWare CA
Parameters:
  ApplicationPassword:
    AllowedPattern: ^(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])[A-Za-z0-9!#$%&()*+,.:;<=>?\[\]^_`{|}~-]*$
    Description: 'User password for the Management Console. The password must contain
      8 to 64 printable ASCII characters, excluding: /, ", '', \ and @, and must contain
      1 uppercase letter, 1 lowercase letter, and 1 number.'
    MaxLength: 64
    MinLength: 8
    NoEcho: 'true'
    Type: String
  ApplicationUser:
    AllowedPattern: ^[\x00-\x7F]*$
    ConstraintDescription: User name must contain 1 to 64 ASCII characters.
    Default: ConsoleAdmin
    Description: The user name for the Management Console, consisting of 1-64 ASCII
      characters.
    MaxLength: '64'
    MinLength: '1'
    Type: String
  AvailabilityZones:
    Description: The list of Availability Zones to use for the subnets in the VPC.
      The Quick Start uses two Availability Zones from your list and preserves the
      logical order you specify.
    Type: List<AWS::EC2::AvailabilityZone::Name>
  DataTransportService:
    AllowedValues:
      - AWS IoT
      - Amazon Kinesis
    Default: Amazon Kinesis
    Description: Method that defines how data from server will be delivered to AWS.
      You can AWS Kinesis or AWS IoT. Depending on your choice, enter values for the
      parameters in one of the next two categories.
    Type: String
  ECSClusterSize:
    Description: Number of instances in ECS cluster
    Default: 1
    Type: Number
  ECSInstanceType:
    AllowedValues:
      - t2.small
      - t2.medium
      - t2.large
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.12xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
    ConstraintDescription: must be a valid EC2 instance type.
    Default: t2.small
    Description: Type of instances in ECS cluster
    Type: String
  ElasticsearchNodeCount:
    Default: '1'
    Description: The number of nodes in the Elasticsearch cluster.
    Type: Number
  ElasticsearchNodeType:
    AllowedValues:
      - t2.small.elasticsearch
      - m4.large.elasticsearch
      - m4.xlarge.elasticsearch
      - c4.large.elasticsearch
      - c4.xlarge.elasticsearch
      - r4.large.elasticsearch
      - r4.xlarge.elasticsearch
    ConstraintDescription: must be a valid Elasticsearch node type.
    Default: t2.small.elasticsearch
    Description: The node type to be provisioned for the Elasticsearch cluster.
    Type: String
  ElasticsearchVolumeSize:
    Default: 10
    Description: Size of EBS volume in Gigabytes
    Type: Number
  EnableS3LifecycleRules:
    AllowedValues:
      - 'yes'
      - 'no'
    Default: 'yes'
    Description: Set to no if you want to disable Amazon S3 lifecycle rules. For more
      information, see the Amazon S3 documentation.
    Type: String
  GlacierTransitionPeriodInDays:
    Default: 365
    Description: Number of days after which data is transitioned to Amazon Glacier.
    Type: Number
  IATransitionPeriodInDays:
    Default: 90
    Description: Number of days after which data is transitioned to infrequent access
      (IA) in Amazon S3. For more information, see the Amazon S3 documentation.
    Type: Number
  KeyName:
    ConstraintDescription: Can contain only ASCII characters.
    Description: Public/private key pair, which allows you to connect securely to
      your instance after it launches. When you created an AWS account, this is the
      key pair you created in your preferred region.
    Type: AWS::EC2::KeyPair::KeyName
  KinesisStreamsShardsCount:
    Default: 2
    Description: The number of Kinesis Data Streams shards to provision for the feed
      data stream. For guidance, see the Amazon Kinesis Data Streams documentation.
      Required only if Stream Delivery Method is set to "kinesis"
    MinValue: 1
    Type: Number
  LogGroupNamePrefix:
    Default: ConnectorLogGroup
    Description: Name of the Amazon CloudWatch log group for metric filters.
    Type: String
  MaxIndexAge:
    Default: 7
    Description: The number of days after which managed feeds are removed from Amazon
      ES. Data is permanently stored in Amazon S3.
    Type: Number
  MetricNamespaceNamePrefix:
    Default: ConnectorMetricNamespace
    Description: Namespace name for the metric filters.
    Type: String
  IoTMetricNamespacePrefix:
    Default: IoTMetricNamespace
    Description: Name of the metrics namespace for monitoring update rate for feeds
      values
    Type: String
  IoTCreateIndividualLogs:
    AllowedValues:
      - 'Yes'
      - 'No'
    Description: Whether each managed feed should be monitored by a separate metric
      in CloudWatch. Note that enabling this option will noticeably increase the cost
      of the deployment.
    Default: 'No'
    Type: String

  KepWareCertS3KeyName:
    Description: S3 key name with certificate file used to authorize to KepWare server
    Type: String
  KepWareIP:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$
    ConstraintDescription: KerServerEX IP must be a valid IP address.
    Description: IP of the KepServerEX server
    Type: String
  KepWarePort:
    ConstraintDescription: KepServerEX port must be a valid number.
    Default: 49322
    Description: Port on which KepServerEX server listens for OPC UA connections
    Type: Number
  KepWareKeysS3BucketName:
    Description: Bucket name for KepWare keys and certificates
    Type: String
  KepWarePassword:
    Description: Password to the KepWare server
    Type: String
  KepWarePrivateKeyS3KeyName:
    Description: S3 key name to the private key file used to authorize to KepWare server
    Type: String
  KepWareUsername:
    Description: Username to the KepWare server
    Type: String

  QSDeploymentSuffix:
    AllowedPattern: '[a-z0-9]+'
    ConstraintDescription: Deployment suffix can include numbers, lowercase letters
      and should have the maximum length of 7 characters.
    Default: qs
    Description: You can deploy this Quick Start multiple times in the same AWS Region
      if you provide a different suffix with each launch. This suffix is added to
      resource names to make them unique for each deployment. Use this parameter to
      support the deployment of production and test environments in the same AWS Region
      and in the same AWS account. The suffix is a 1-7 character string that contains
      numbers and lowercase letters.
    MaxLength: 12
    MinLength: 1
    Type: String
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen
      (-).
    Default: aws-quickstart
    Description: S3 bucket where the Quick Start templates and scripts are installed.
      Use this parameter to specify the S3 bucket name you've created for your copy
      of Quick Start assets, if you decide to customize or extend the Quick Start
      for your own use. The bucket name can include numbers, lowercase letters, uppercase
      letters, and hyphens, but should not start or end with a hyphen.
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-][0-9a-zA-Z-/]*/$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/).
    Default: quickstart-osisoft-pisystem2aws-connector/
    Description: The S3 key name prefix used to simulate a folder for your copy of
      Quick Start assets, if you decide to customize or extend the Quick Start for
      your own use. This prefix can include numbers, lowercase letters, uppercase
      letters, hyphens, and forward slashes.
    Type: String
  RemoteAccessCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/x
    Description: The CIDR IP range that is permitted to access the OSIsoft PI System
      to AWS Connector software. We recommend that you set this value to a trusted
      IP range. For example, you might want to grant only your corporate network access
      to the software. You can use http://checkip.amazonaws.com/ to check your IP
      address. This parameter must be in the form x.x.x.x/x (e.g., 96.127.8.12/32,
      YOUR_IP/32).
    Type: String
  VPCDefinition:
    Default: QuickstartDefault
    Description: VPC definition name from the Mappings section of the template. Each
      definition specifies a VPC configuration, including the number of Availability
      Zones to be used for the deployment and the CIDR blocks for the VPC, public
      subnets, and private subnets. You can support multiple VPC configurations by
      extending the map with additional definitions and choosing the appropriate name.
      If you don't want to change the VPC configuration, keep the default setting.
    Type: String
  RDSInstanceType:
    AllowedValues:
      - db.t2.micro
      - db.t2.small
      - db.t2.medium
      - db.t2.large
    Default: db.t2.small
    Description: The type of the RDS instance that is being created.
    Type: String
  RDSPassword:
    AllowedPattern: ^(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])[A-Za-z0-9!#$%&()*+,.:;<=>?\[\]^_`{|}~-]*$
    ConstraintDescription: 'Password must contain 8 to 64 printable ASCII characters
      excluding: /, ", \'', \ and @. It must contain 1 uppercase letter, 1 lowercase
      letter, and 1 number.'
    Description: 'The password that is associated with the master user account for
      the RDS that is being created. Password must contain 8 to 64 printable ASCII
      characters excluding: /, ", \'', \ and @. It must contain 1 uppercase letter,
      1 lowercase letter, and 1 number.'
    MaxLength: '64'
    MinLength: '8'
    NoEcho: 'true'
    Type: String
  RDSUsername:
    AllowedPattern: ^[a-z][a-z0-9_]*$
    ConstraintDescription: User name parameter must be lowercase, begin with a letter,
      contain only alphanumeric characters or underscores, and be less than 128 characters.
    Default: rdsuser
    Description: The user name that is associated with the master user account for
      the RDS that is being created. User name parameter must be lowercase, begin
      with a letter, contain only alphanumeric characters or underscores, and be less
      than 128 characters.
    MaxLength: '128'
    MinLength: '1'
    Type: String

  UseCustomDockerRepository:
    AllowedValues:
      - Yes
      - No
    Default: No
    Description: Whether use public docker images repository (DockerHub) to download docker images of the microservices
      or use ECR from your own account, if you decide to customize your copy of this Quick Start.
    Type: String

  ApiInstanceDockerTag:
    Default: latest
    Description: Docker tag used to download API Endpoint instance. Change if you decided to customize your copy
      of this Quick Start.
    Type: String
  KepWareConnectorDockerTag:
    Type: String
    Default: latest
    Description: Docker tag used to download KepWare Connector Agent instance. Change if you decided to customize
      your copy of this Quick Start.
  ManagementConsoleDockerTag:
    Default: latest
    Description: Docker tag used to download Management Console Endpoint instance. Change if you decided to customize
      your copy of this Quick Start.
    Type: String
  MosquittoBrokerDockerTag:
    Default: latest
    Description: Docker tag used to download Mosquitto Broker instance. Change if you decided to customize your copy
      of this Quick Start.
    Type: String
Mappings:
  VPCDefinitions:
    QuickstartDefault:
      VPCCIDR: 10.0.0.0/16
      PublicSubnet1CIDR: 10.0.128.0/20
      PrivateSubnet1CIDR: 10.0.0.0/19
      PublicSubnet2CIDR: 10.0.144.0/20
      PrivateSubnet2CIDR: 10.0.32.0/19
      NumberOfAZs: '2'
Resources:
  BastionStack:
    Properties:
      Parameters:
        EnableTCPForwarding: 'true'
        KeyPairName: !Ref 'KeyName'
        PublicSubnet1ID: !GetAtt 'VPCStack.Outputs.PublicSubnet1ID'
        PublicSubnet2ID: !GetAtt 'VPCStack.Outputs.PublicSubnet2ID'
        QSS3BucketName: !Ref 'QSS3BucketName'
        QSS3KeyPrefix: !Sub
          - ${Prefix}submodules/quickstart-linux-bastion/
          - Prefix: !Ref 'QSS3KeyPrefix'
        RemoteAccessCIDR: !Ref 'RemoteAccessCIDR'
        VPCID: !GetAtt 'VPCStack.Outputs.VPCID'
      TemplateURL: !Sub 'https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-linux-bastion/templates/linux-bastion.template'
    Type: AWS::CloudFormation::Stack
  KepWareIDCFoundationStack:
    Properties:
      Parameters:
        ApplicationPassword: !Ref 'ApplicationPassword'
        ApplicationUser: !Ref 'ApplicationUser'
        AvailabilityZones: !Join
          - ','
          - !Ref 'AvailabilityZones'
        ECSClusterSize: !Ref 'ECSClusterSize'
        ECSInstanceType: !Ref 'ECSInstanceType'
        ElasticsearchNodeCount: !Ref 'ElasticsearchNodeCount'
        ElasticsearchNodeType: !Ref 'ElasticsearchNodeType'
        ElasticsearchVolumeSize: !Ref 'ElasticsearchVolumeSize'
        EnableS3LifecycleRules: !Ref 'EnableS3LifecycleRules'
        GlacierTransitionPeriodInDays: !Ref 'GlacierTransitionPeriodInDays'
        IATransitionPeriodInDays: !Ref 'IATransitionPeriodInDays'
        IoTMetricNamespacePrefix: !Ref 'IoTMetricNamespacePrefix'
        KinesisStreamsShardsCount: !Ref 'KinesisStreamsShardsCount'
        LogGroupNamePrefix: !Ref 'LogGroupNamePrefix'
        MaxIndexAge: !Ref 'MaxIndexAge'
        MetricNamespaceNamePrefix: !Ref 'MetricNamespaceNamePrefix'
        PrivateSubnet1ID: !GetAtt 'VPCStack.Outputs.PrivateSubnet1AID'
        PrivateSubnet2ID: !GetAtt 'VPCStack.Outputs.PrivateSubnet2AID'
        PublicSubnet1ID: !GetAtt 'VPCStack.Outputs.PublicSubnet1ID'
        PublicSubnet2ID: !GetAtt 'VPCStack.Outputs.PublicSubnet2ID'
        KepWareCertS3KeyName: !Ref 'KepWareCertS3KeyName'
        KepWareIP: !Ref 'KepWareIP'
        KepWarePort: !Ref 'KepWarePort'
        KepWareKeysS3BucketName: !Ref 'KepWareKeysS3BucketName'
        KepWarePassword: !Ref 'KepWarePassword'
        KepWarePrivateKeyS3KeyName: !Ref 'KepWarePrivateKeyS3KeyName'
        KepWareUsername: !Ref 'KepWareUsername'
        QSDeploymentSuffix: !Ref 'QSDeploymentSuffix'
        QSS3BucketName: !Ref 'QSS3BucketName'
        QSS3KeyPrefix: !Ref 'QSS3KeyPrefix'
        RemoteAccessCIDR: !Ref 'RemoteAccessCIDR'
        VPCCIDR: !GetAtt 'VPCStack.Outputs.VPCCIDR'
        VPCID: !GetAtt 'VPCStack.Outputs.VPCID'
        RDSInstanceType: !Ref 'RDSInstanceType'
        RDSPassword: !Ref 'RDSPassword'
        RDSUsername: !Ref 'RDSUsername'
        DataTransportService: !Ref 'DataTransportService'
        IoTCreateIndividualLogs: !Ref 'IoTCreateIndividualLogs'
        KepWareConnectorDockerTag: !Ref KepWareConnectorDockerTag
        ManagementConsoleDockerTag: !Ref ManagementConsoleDockerTag
        ApiInstanceDockerTag: !Ref ApiInstanceDockerTag
        MosquittoBrokerDockerTag: !Ref MosquittoBrokerDockerTag
        UseCustomDockerRepository: !Ref UseCustomDockerRepository
      TemplateURL: !Sub 'https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/kepware-industrial-data-connector.yaml'
    Type: AWS::CloudFormation::Stack
  VPCStack:
    Properties:
      Parameters:
        AvailabilityZones: !Join
          - ','
          - !Ref 'AvailabilityZones'
        KeyPairName: !Ref 'KeyName'
        NumberOfAZs: !FindInMap
          - VPCDefinitions
          - !Ref 'VPCDefinition'
          - NumberOfAZs
        PrivateSubnet1ACIDR: !FindInMap
          - VPCDefinitions
          - !Ref 'VPCDefinition'
          - PrivateSubnet1CIDR
        PrivateSubnet2ACIDR: !FindInMap
          - VPCDefinitions
          - !Ref 'VPCDefinition'
          - PrivateSubnet2CIDR
        PublicSubnet1CIDR: !FindInMap
          - VPCDefinitions
          - !Ref 'VPCDefinition'
          - PublicSubnet1CIDR
        PublicSubnet2CIDR: !FindInMap
          - VPCDefinitions
          - !Ref 'VPCDefinition'
          - PublicSubnet2CIDR
        VPCCIDR: !FindInMap
          - VPCDefinitions
          - !Ref 'VPCDefinition'
          - VPCCIDR
      TemplateURL: !Sub 'https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-aws-vpc/templates/aws-vpc.template'
    Type: AWS::CloudFormation::Stack
Outputs:
  ManagementConsoleURL:
    Value: !GetAtt 'KepWareIDCFoundationStack.Outputs.ManagementConsoleURL'
    Description: Management Console URL
  ElasticsearchEndpoint:
    Value: !GetAtt 'KepWareIDCFoundationStack.Outputs.ElasticsearchEndpoint'
    Description: Elasticsearch domain endpoint
  CuratedBucketName:
    Value: !GetAtt 'KepWareIDCFoundationStack.Outputs.CuratedBucketName'
    Description: Bucket name for Curated Datasets
  PublishedBucketName:
    Value: !GetAtt 'KepWareIDCFoundationStack.Outputs.PublishedBucketName'
    Description: Bucket name for Published Data
  SubmissionsBucketName:
    Value: !GetAtt 'KepWareIDCFoundationStack.Outputs.SubmissionsBucketName'
    Description: Bucket name for submissions
  KinesisStreamName:
    Value: !GetAtt 'KepWareIDCFoundationStack.Outputs.KinesisStreamName'
    Description: Kinesis feeds data stream name
  BastionIP:
    Value: !GetAtt 'BastionStack.Outputs.EIP1'
    Description: Bastion IP
