AWSTemplateFormatVersion: '2010-09-09'
Description: AWS Cloudformation template to deploy Industrial Data Connector Quick Start into existing VPC. **WARNING**
  You will be billed for the AWS resources used if you create a stack from this template.
Conditions:
  UseIoT: !Equals
    - !Ref 'DataTransportService'
    - AWS IoT
  UseKinesis: !Equals
    - !Ref 'DataTransportService'
    - Amazon Kinesis
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network Configuration
        Parameters:
          - RemoteAccessCIDR
          - AvailabilityZones
          - VPCCIDR
          - VPCID
          - PrivateSubnet1ID
          - PrivateSubnet2ID
          - PublicSubnet1ID
          - PublicSubnet2ID
          - KeyName
          - PISubnetType
      - Label:
          default: Licensed 3rd-party Software Installers Configuration
        Parameters:
          - LicensedSoftwareS3BucketName
          - LicensedSoftwareS3KeyPrefix
          - ConnectorAgentAssetsS3BucketName
          - ConnectorAgentAssetsS3KeyPrefix
      - Label:
          default: ECS cluster configuration
        Parameters:
          - ECSClusterSize
          - ECSInstanceType
      - Label:
          default: OSIsoft Authentication Configuration
        Parameters:
          - AuthType
      - Label:
          default: Authentication Configuration for WIS
        Parameters:
          - WISFQDN
          - WISUser
          - WISPassword
          - DomainControllerServerIP
      - Label:
          default: Authentication Configuration for Explicit User and Password
        Parameters:
          - PIUser
          - PIPassword
          - AFDomainName
          - AFUser
          - AFPassword
      - Label:
          default: PI Data Archive Server Configuration
        Parameters:
          - PIServerIP
          - PIPort
      - Label:
          default: Asset Framework Server Configuration
        Parameters:
          - AFServerIP
          - AFPort
          - AsStructureDatabase
      - Label:
          default: Connector Agent Configuration
        Parameters:
          - ConnectorInstanceType
          - LogGroupNamePrefix
          - MetricNamespaceNamePrefix
      - Label:
          default: Management Console Configuration
        Parameters:
          - ApplicationUser
          - ApplicationPassword
      - Label:
          default: RDS Configuration
        Parameters:
          - RDSUsername
          - RDSPassword
          - RDSInstanceType
      - Label:
          default: Connector Supporting Infrastructure Configuration
        Parameters:
          - DataTransportService
      - Label:
          default: Kinesis Configuration
        Parameters:
          - KinesisStreamsShardsCount
      - Label:
          default: IoT Configuration
        Parameters:
          - IoTMetricNamespacePrefix
          - IoTCreateIndividualLogs
      - Label:
          default: Elasticsearch Configuration
        Parameters:
          - MaxIndexAge
          - ElasticsearchNodeCount
          - ElasticsearchNodeType
          - ElasticsearchVolumeSize
      - Label:
          default: S3 Lifecycle Management
        Parameters:
          - EnableS3LifecycleRules
          - IATransitionPeriodInDays
          - GlacierTransitionPeriodInDays
      - Label:
          default: AWS Quick Start Configuration
        Parameters:
          - QSS3BucketName
          - QSS3KeyPrefix
          - QSDeploymentSuffix
    ParameterLabels:
      AFDomainName:
        default: Asset Framework Domain Name
      AFPassword:
        default: Asset Framework Password
      AFPort:
        default: Asset Framework Port
      AFServerIP:
        default: Asset Framework Server IP
      AFUser:
        default: Asset Framework User
      AsStructureDatabase:
        default: Asset Framework Structure Database
      ApplicationPassword:
        default: Management Console Password
      ApplicationUser:
        default: Management Console User Name
      AuthType:
        default: Authentication Method
      AvailabilityZones:
        default: Availability Zones
      ConnectorAgentAssetsS3BucketName:
        default: Connector Agent Assets S3 Bucket Name
      ConnectorAgentAssetsS3KeyPrefix:
        default: Connector Agent Assets S3 Key Prefix
      ConnectorInstanceType:
        default: Connector Agent Instance Type
      DomainControllerServerIP:
        default: Domain Controller Server IP
      ECSClusterSize:
        default: Number of instances in ECS cluster
      ECSInstanceType:
        default: Type of instances in ECS cluster
      ElasticsearchNodeCount:
        default: Elasticsearch Node Count
      ElasticsearchNodeType:
        default: Elasticsearch Node Type
      ElasticsearchVolumeSize:
        default: Size of EBS volume in Gigabytes
      RDSInstanceType:
        default: RDS Instance Type
      RDSPassword:
        default: RDS Password
      RDSUsername:
        default: RDS User Name
      EnableS3LifecycleRules:
        default: Enable S3 Lifecycle
      GlacierTransitionPeriodInDays:
        default: Glacier Transition Period
      IATransitionPeriodInDays:
        default: IA Transition Period
      KeyName:
        default: Key Name
      KinesisStreamsShardsCount:
        default: Kinesis Streams Shards Count
      LicensedSoftwareS3BucketName:
        default: Licensed Software S3 Bucket Name
      LicensedSoftwareS3KeyPrefix:
        default: Licensed Software S3 Key Prefix
      LogGroupNamePrefix:
        default: Log Group Name Prefix
      MaxIndexAge:
        default: Days to Live
      MetricNamespaceNamePrefix:
        default: Metric Namespace Name Prefix
      IoTMetricNamespacePrefix:
        default: IoT Metric Namespace Name Prefix
      IoTCreateIndividualLogs:
        Type: String
      PIPassword:
        default: PI Password
      PIPort:
        default: PI Port
      PIServerIP:
        default: PI Server IP
      PISubnetType:
        default: PI Subnet Type
      PIUser:
        default: PI User
      PrivateSubnet1ID:
        default: Existing VPC Private Subnet 1 ID
      PrivateSubnet2ID:
        default: Existing VPC Private Subnet 2 ID
      PublicSubnet1ID:
        default: Existing VPC Public Subnet 1 ID
      PublicSubnet2ID:
        default: Existing VPC Public Subnet 2 ID
      QSDeploymentSuffix:
        default: Quick Start Deployment Suffix
      QSS3BucketName:
        default: Quick Start S3 Bucket Name
      QSS3KeyPrefix:
        default: Quick Start S3 Key Prefix
      RemoteAccessCIDR:
        default: Remote Access CIDR
      DataTransportService:
        default: Data transport service
      VPCCIDR:
        default: Existing VPC CIDR
      VPCID:
        default: Existing VPC ID
      WISFQDN:
        default: WIS Domain Name
      WISPassword:
        default: WIS Domain User Password
      WISUser:
        default: WIS Domain User Name
Parameters:
  AFDomainName:
    Description: Domain name of the user who runs AF Server. This parameter is required
      only if you set Authentication Method to Explicit user and password and you
      adopted AF Server in your OSIsoft system. This Quick Start can independently
      connect to PI Data Archive and AF Server.
    Type: String
  AFPassword:
    Description: Password of the user who has privileges to access AF Server. This
      parameter is required only if Authentication Method is set to Explicit user
      and password and you adopted AF Server in your OSIsoft system. This Quick Start
      can independently connect to PI Data Archive and AF Server.
    NoEcho: 'true'
    Type: String
  AFPort:
    Default: 5457
    Description: Port on which PI AF server runs. This parameter is required only
      if you adopted AF Server in your OSIsoft system. This Quick Start can independently
      connect to PI Data Archive and AF Server.
    Type: Number
  AFServerIP:
    AllowedPattern: ^((([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]))?$
    Description: Host (IP) of the PI AF server. This parameter is required only if
      you adopted AF Server in your OSIsoft system. This Quick Start can independently
      connect to PI Data Archive and AF Server.
    Type: String
  AFUser:
    Description: Name of the user who has privileges to access PI Asset Framework
      Server. This parameter is required only if you set Authentication Method to
      Explicit user and password and you adopted AF Server in your OSIsoft system.
      This Quick Start can independently connect to PI Data Archive and AF Server.
    Type: String
  AsStructureDatabase:
    Description: Name of the AF database that Connector Agent will connect to; for
      example, NuGreen. This parameter is required only if you adopted AF Server in
      your OSIsoft system. This Quick Start can independently connect to PI Data Archive
      and AF Server.
    Type: String
  ApplicationPassword:
    AllowedPattern: ^(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])[A-Za-z0-9!#$%&()*+,.:;<=>?\[\]^_`{|}~-]*$
    Description: 'User password for the Management Console. The password must contain
      8 to 64 printable ASCII characters, excluding: /, ", '', \ and @, and must contain
      1 uppercase letter, 1 lowercase letter, and 1 number.'
    MaxLength: 64
    MinLength: 8
    NoEcho: 'true'
    Type: String
  ApplicationUser:
    AllowedPattern: ^[\x00-\x7F]*$
    ConstraintDescription: User name must contain 1 to 64 ASCII characters.
    Default: ConsoleAdmin
    Description: The user name for the Management Console, consisting of 1-64 ASCII
      characters.
    MaxLength: '64'
    MinLength: '1'
    Type: String
  AuthType:
    AllowedValues:
      - WIS
      - Explicit user and password
    Default: WIS
    Description: 'The authentication method to use between the Connector and the OSIsoft
      PI System. Two authentication methods are supported: Windows Integrated Security
      (WIS) and explicit user and password authentication. If you are using Active
      Directory with your OSIsoft PI System and already have VPN established, you
      can use the WIS authentication method. If you don''t use WIS, you can specify
      Explicit user and password. Depending on your choice, enter values for the parameters
      in one of the next two categories.'
    Type: String
  AvailabilityZones:
    Description: The list of Availability Zones to use for the subnets in the VPC.
      You must specify two Availability Zones. By default, the Quick Start preserves
      the logical order you specify.
    Type: List<AWS::EC2::AvailabilityZone::Name>
  ConnectorAgentAssetsS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: S3 bucket name can include numbers, lowercase letters,
      uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: aws-quickstart-datasets
    Description: S3 bucket where Connector Agent sources are installed. The bucket
      name can include numbers, lowercase letters, uppercase letters, and hyphens,
      but should not start or end with a hyphen.
    Type: String
  ConnectorAgentAssetsS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-][0-9a-zA-Z-/]*/$
    ConstraintDescription: The S3 key name prefix to where Connector Agent sources
      are installed. This prefix can include numbers, lowercase letters, uppercase
      letters, hyphens, and forward slashes.
    Default: osisoft/agent/v2/
    Description: The S3 key name prefix to where Connector Agent sources are installed.
      This prefix can include numbers, lowercase letters, uppercase letters, hyphens,
      and forward slashes.
    Type: String
  ConnectorInstanceType:
    AllowedValues:
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.12xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
    ConstraintDescription: must be a valid EC2 instance type.
    Default: t2.micro
    Description: EC2 instance type for the Connector Agent instance.
    Type: String
  DataTransportService:
    AllowedValues:
      - AWS IoT
      - Amazon Kinesis
    Default: Amazon Kinesis
    Description: Method that defines how data from feed server will be delivered to
      AWS. You can AWS Kinesis or AWS IoT. Depending on your choice, enter values
      for the parameters in one of the next two categories.
    Type: String
  DomainControllerServerIP:
    AllowedPattern: ^((([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]))?$
    Description: Host (IP) of the AD Domain Controller server. Required only if Authentication
      Method is set to "WIS".
    Type: String
  ECSClusterSize:
    Description: Number of instances in ECS cluster
    Default: 1
    Type: Number
  ECSInstanceType:
    AllowedValues:
      - t2.small
      - t2.medium
      - t2.large
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.12xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
    ConstraintDescription: must be a valid EC2 instance type.
    Default: t2.small
    Description: Type of instances in ECS cluster
    Type: String
  ElasticsearchNodeCount:
    Default: '1'
    Description: The number of nodes in the Elasticsearch cluster.
    Type: Number
  ElasticsearchNodeType:
    AllowedValues:
      - t2.small.elasticsearch
      - m4.large.elasticsearch
      - m4.xlarge.elasticsearch
      - c4.large.elasticsearch
      - c4.xlarge.elasticsearch
      - r4.large.elasticsearch
      - r4.xlarge.elasticsearch
    ConstraintDescription: must be a valid Elasticsearch node type.
    Default: t2.small.elasticsearch
    Description: The node type to be provisioned for the Elasticsearch cluster.
    Type: String
  ElasticsearchVolumeSize:
    Default: 10
    Description: Size of EBS volume in Gigabytes
    Type: Number
  EnableS3LifecycleRules:
    AllowedValues:
      - 'yes'
      - 'no'
    Default: 'yes'
    Description: Set to no if you want to disable Amazon S3 lifecycle rules. For more
      information, see the Amazon S3 documentation.
    Type: String
  GlacierTransitionPeriodInDays:
    Default: 365
    Description: Number of days after which data is transitioned to Amazon Glacier.
    Type: Number
  IATransitionPeriodInDays:
    Default: 90
    Description: Number of days after which data is transitioned to infrequent access
      (IA) in Amazon S3. For more information, see the Amazon S3 documentation.
    Type: Number
  KeyName:
    ConstraintDescription: Can contain only ASCII characters.
    Description: Public/private key pair, which allows you to connect securely to
      your instance after it launches. When you created an AWS account, this is the
      key pair you created in your preferred region.
    Type: AWS::EC2::KeyPair::KeyName
  KinesisStreamsShardsCount:
    Default: 2
    Description: The number of Kinesis Data Streams shards to provision for the feed
      data stream. For guidance, see the Amazon Kinesis Data Streams documentation.
    MinValue: 1
    Type: Number
  LicensedSoftwareS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: S3 bucket bucket name can include numbers, lowercase letters,
      uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: S3 bucket where the Microsoft and OSIsoft licensed software (.NET
      Framework, PI AF Client SDK) are installed. The bucket name can include numbers,
      lowercase letters, uppercase letters, and hyphens, but should not start or end
      with a hyphen.
    Type: String
  LicensedSoftwareS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-][0-9a-zA-Z-/]*/$
    ConstraintDescription: The S3 key name prefix for required licensed software.
      This prefix can include numbers, lowercase letters, uppercase letters, hyphens,
      and forward slashes.
    Description: The S3 key name prefix for required licensed software. This prefix
      can include numbers, lowercase letters, uppercase letters, hyphens, and forward
      slashes.
    Type: String
  LogGroupNamePrefix:
    Default: ConnectorLogGroup
    Description: Name of the Amazon CloudWatch log group for metric filters.
    Type: String
  MaxIndexAge:
    Default: 7
    Description: The number of days after which managed feeds are removed from Amazon
      ES. Data is permanently stored in Amazon S3.
    Type: Number
  MetricNamespaceNamePrefix:
    Default: ConnectorMetricNamespace
    Description: Namespace name for the metric filters.
    Type: String
  IoTMetricNamespacePrefix:
    Default: IoTMetricNamespacePrefix
    Description: Name of the metrics namespace for monitoring update rate for feeds
      values
    Type: String
  IoTCreateIndividualLogs:
    AllowedValues:
      - 'Yes'
      - 'No'
    Description: Whether each managed feed should be monitored by a separate metric
      in CloudWatch. Note that enabling this option will noticeably increase the cost
      of the deployment.
    Default: 'No'
    Type: String
  PIPassword:
    Description: Password for the PI Data Archive user. Required only if Authentication
      Method is set to "Explicit user and password".
    NoEcho: 'true'
    Type: String
  PIPort:
    ConstraintDescription: PI Server port must be a valid number.
    Default: 5450
    Description: Port on which PI Data Archive runs.
    Type: Number
  PIServerIP:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$
    ConstraintDescription: PI Server IP must be a valid IP address.
    Description: Host (IP) of the PI Data Archive server.
    Type: String
  PISubnetType:
    AllowedValues:
      - Public
      - Private
    Default: Public
    Description: PI Connector Agent subnet type. It can be public or private. **WARNING**
      Using private subnet for Connector Agent and VPN will not work together.
    Type: String
  PIUser:
    Description: Name of the PI Data Archive user. Required only if Authentication
      Method is set to "Explicit user and password".
    Type: String
  PrivateSubnet1ID:
    Description: ID of the private subnet 1 in Availability Zone 1 (e.g., subnet-a0246dcd)
    Type: AWS::EC2::Subnet::Id
  PrivateSubnet2ID:
    Description: ID of the private subnet 2 in Availability Zone 2 (e.g., subnet-a0246dcd)
    Type: AWS::EC2::Subnet::Id
  PublicSubnet1ID:
    Description: ID of the public subnet 1 in Availability Zone 1 (e.g., subnet-a0246dcd)
    Type: AWS::EC2::Subnet::Id
  PublicSubnet2ID:
    Description: ID of the public subnet 2 in Availability Zone 2 (e.g., subnet-a0246dcd)
    Type: AWS::EC2::Subnet::Id
  QSDeploymentSuffix:
    AllowedPattern: '[a-z0-9]+'
    ConstraintDescription: Deployment suffix can include numbers, lowercase letters
      and should have the maximum length of 7 characters.
    Default: qs
    Description: You can deploy this Quick Start multiple times in the same AWS Region
      if you provide a different suffix with each launch. This suffix is added to
      resource names to make them unique for each deployment. Use this parameter to
      support the deployment of production and test environments in the same AWS Region
      and in the same AWS account. The suffix is a 1-7 character string that contains
      numbers and lowercase letters.
    MaxLength: 12
    MinLength: 1
    Type: String
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen
      (-).
    Default: aws-quickstart
    Description: S3 bucket where the Quick Start templates and scripts are installed.
      Use this parameter to specify the S3 bucket name you've created for your copy
      of Quick Start assets, if you decide to customize or extend the Quick Start
      for your own use. The bucket name can include numbers, lowercase letters, uppercase
      letters, and hyphens, but should not start or end with a hyphen.
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-][0-9a-zA-Z-/]*/$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/).
    Default: quickstart-47lining-industrial-data-connector/
    Description: The S3 key name prefix used to simulate a folder for your copy of
      Quick Start assets, if you decide to customize or extend the Quick Start for
      your own use. This prefix can include numbers, lowercase letters, uppercase
      letters, hyphens, and forward slashes.
    Type: String
  RemoteAccessCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/x
    Description: The CIDR IP range that is permitted to access the OSIsoft PI System
      to AWS Connector software. We recommend that you set this value to a trusted
      IP range. For example, you might want to grant only your corporate network access
      to the software. You can use http://checkip.amazonaws.com/ to check your IP
      address. This parameter must be in the form x.x.x.x/x (e.g., 96.127.8.12/32,
      YOUR_IP/32).
    Type: String
  VPCCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Description: CIDR block for the VPC.
    Type: String
  VPCID:
    Description: ID of your existing VPC (e.g., vpc-0343606e).
    Type: AWS::EC2::VPC::Id
  WISFQDN:
    Default: ''
    Description: Fully qualified domain name (FQDN) of the forest domain for the OSIsoft
      system e.g. "osisoft-example.com". Required only if Authentication Method is
      set to "WIS".
    Type: String
  WISPassword:
    Default: ''
    Description: The password (in Active Directory in your Windows network) for the
      user who has privileges to access PI Data Archive and AF Server. Required only
      if Authentication Method is set to "WIS".
    NoEcho: 'true'
    Type: String
  WISUser:
    Default: ''
    Description: The user name (in Active Directory in your Windows network) for the
      user who has privileges to access PI Data Archive and AF Server. Required only
      if Authentication Method is set to "WIS".
    Type: String
  RDSInstanceType:
    AllowedValues:
      - db.t2.micro
      - db.t2.small
      - db.t2.medium
      - db.t2.large
    Default: db.t2.small
    Description: The type of the RDS instance that is being created.
    Type: String
  RDSPassword:
    AllowedPattern: ^(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])[A-Za-z0-9!#$%&()*+,.:;<=>?\[\]^_`{|}~-]*$
    ConstraintDescription: 'Password must contain 8 to 64 printable ASCII characters
      excluding: /, ", \'', \ and @. It must contain 1 uppercase letter, 1 lowercase
      letter, and 1 number.'
    Description: 'The password that is associated with the master user account for
      the RDS that is being created. Password must contain 8 to 64 printable ASCII
      characters excluding: /, ", \'', \ and @. It must contain 1 uppercase letter,
      1 lowercase letter, and 1 number.'
    MaxLength: '64'
    MinLength: '8'
    NoEcho: 'true'
    Type: String
  RDSUsername:
    AllowedPattern: ^[a-z][a-z0-9_]*$
    ConstraintDescription: User name parameter must be lowercase, begin with a letter,
      contain only alphanumeric characters or underscores, and be less than 128 characters.
    Default: rdsuser
    Description: The user name that is associated with the master user account for
      the RDS that is being created. User name parameter must be lowercase, begin
      with a letter, contain only alphanumeric characters or underscores, and be less
      than 128 characters.
    MaxLength: '128'
    MinLength: '1'
    Type: String
  ManagementConsoleDockerTag:
    Type: String
    Default: latest
  ApiInstanceDockerTag:
    Type: String
    Default: latest
  MosquittoBrokerDockerTag:
    Type: String
    Default: latest
  UseCustomDockerRepository:
    Type: String
    AllowedValues:
    - Yes
    - No
    Description: Indicates whether this deployment is a quickstart or not.
Resources:
  PIConnectorStack:
    DependsOn:
      - IDCFoundationStack
    Properties:
      Parameters:
        AFDomainName: !Ref 'AFDomainName'
        AFPassword: !Ref 'AFPassword'
        AFPort: !Ref 'AFPort'
        AFServerIP: !Ref 'AFServerIP'
        AFUser: !Ref 'AFUser'
        AsStructureDatabase: !Ref 'AsStructureDatabase'
        AuthType: !Ref 'AuthType'
        BackfillQueueURL: !GetAtt 'IDCFoundationStack.Outputs.BackfillQueueURL'
        ConnectorAgentAssetsS3BucketName: !Ref 'ConnectorAgentAssetsS3BucketName'
        ConnectorAgentAssetsS3KeyPrefix: !Ref 'ConnectorAgentAssetsS3KeyPrefix'
        ConnectorAgentInstanceProfileARN: !GetAtt 'IDCFoundationStack.Outputs.ConnectorAgentInstanceProfileARN'
        ConnectorInstanceType: !Ref 'ConnectorInstanceType'
        CreateTablesLambdaRoleARN: !GetAtt 'IDCFoundationStack.Outputs.CreateTablesLambdaRoleARN'
        CuratedDataBucketName: !GetAtt 'IDCFoundationStack.Outputs.CuratedDataBucketName'
        CopyLicensedBinaryLambdaRoleARN: !GetAtt 'IDCFoundationStack.Outputs.CopyLicensedBinaryLambdaRoleARN'
        DataTransportService: !Ref 'DataTransportService'
        DomainControllerServerIP: !Ref 'DomainControllerServerIP'
        ElasticsearchDomainEndpoint: !GetAtt 'IDCFoundationStack.Outputs.ElasticsearchDomainEndpoint'
        IncomingQueueURL: !GetAtt 'IDCFoundationStack.Outputs.IncomingQueueURL'
        InterpolationQueueURL: !GetAtt 'IDCFoundationStack.Outputs.InterpolationQueueURL'
        KinesisStreamName: !GetAtt 'IDCFoundationStack.Outputs.KinesisStreamName'
        KeyName: !Ref 'KeyName'
        LicensedSoftwareS3BucketName: !Ref LicensedSoftwareS3BucketName
        LicensedSoftwareS3KeyPrefix: !Ref LicensedSoftwareS3KeyPrefix
        LogGroupName: !Sub '${LogGroupNamePrefix}-${QSDeploymentSuffix}'
        LogsToElasticsearchRoleARN: !GetAtt 'IDCFoundationStack.Outputs.LogsToElasticsearchRoleARN'
        MetricNamespaceName: !Sub '${MetricNamespaceNamePrefix}-${QSDeploymentSuffix}'
        MosquittoBrokerHost: !GetAtt 'IDCFoundationStack.Outputs.MosquittoBrokerHost'
        MosquittoBrokerPort: '8883'
        PIPassword: !Ref 'PIPassword'
        PIPort: !Ref 'PIPort'
        PIServerIP: !Ref 'PIServerIP'
        PISubnetType: !Ref 'PISubnetType'
        PIUser: !Ref 'PIUser'
        PostgresUri: !GetAtt 'IDCFoundationStack.Outputs.PostgresUri'
        PrivateSubnet1ID: !Ref 'PrivateSubnet1ID'
        PrivateSubnet2ID: !Ref 'PrivateSubnet2ID'
        PublicSubnet1ID: !Ref 'PublicSubnet1ID'
        PublicSubnet2ID: !Ref 'PublicSubnet2ID'
        OutgoingQueueURL: !GetAtt 'IDCFoundationStack.Outputs.OutgoingQueueURL'
        QSDeploymentSuffix: !Ref 'QSDeploymentSuffix'
        QSS3BucketName: !Ref 'QSS3BucketName'
        QSS3KeyPrefix: !Ref 'QSS3KeyPrefix'
        RegionalLambdaBucketARN: !GetAtt 'IDCFoundationStack.Outputs.RegionalLambdaBucketARN'
        RegionalLambdaBucketName: !GetAtt 'IDCFoundationStack.Outputs.RegionalLambdaBucketName'
        RemoteAccessCIDR: !Ref 'RemoteAccessCIDR'
        SubscriptionQueueURL: !GetAtt 'IDCFoundationStack.Outputs.SubscriptionQueueURL'
        WISFQDN: !Ref 'WISFQDN'
        WISPassword: !Ref 'WISPassword'
        WISUser: !Ref 'WISUser'
        VPCID: !Ref 'VPCID'
        VPCCIDR: !Ref 'VPCCIDR'
        AutoBackfillerLambdaRoleARN: !GetAtt 'IDCFoundationStack.Outputs.AutoBackfillerLambdaRoleARN'
        SaveStatusLambdaRoleARN: !GetAtt 'IDCFoundationStack.Outputs.SaveStatusLambdaRoleARN'
        VPCDestroyEniExecutionRoleARN: !GetAtt 'IDCFoundationStack.Outputs.VPCDestroyEniExecutionRoleARN'
        BackfillQueueUrl: !GetAtt 'IDCFoundationStack.Outputs.BackfillQueueURL'
        DbName: !GetAtt 'IDCFoundationStack.Outputs.RDSDatabaseName'
        DbUsername: !Ref RDSUsername
        DbPassword: !Ref RDSPassword
        DbHost: !GetAtt 'IDCFoundationStack.Outputs.RDSHostname'
      TemplateURL: !Sub 'https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/pi-connector.template'
    Type: AWS::CloudFormation::Stack
  IDCFoundationStack:
    Properties:
      Parameters:
        ApplicationPassword: !Ref 'ApplicationPassword'
        ApplicationUser: !Ref 'ApplicationUser'
        AvailabilityZones: !Join
          - ','
          - !Ref 'AvailabilityZones'
        ConnectorAgentAssetsS3BucketName: !Ref 'ConnectorAgentAssetsS3BucketName'
        ConnectorType: PI
        DataTransportService: !Ref 'DataTransportService'
        ECSClusterSize: !Ref 'ECSClusterSize'
        ECSInstanceType: !Ref 'ECSInstanceType'
        ElasticsearchNodeCount: !Ref 'ElasticsearchNodeCount'
        ElasticsearchNodeType: !Ref 'ElasticsearchNodeType'
        ElasticsearchVolumeSize: !Ref 'ElasticsearchVolumeSize'
        EnableS3LifecycleRules: !Ref 'EnableS3LifecycleRules'
        GlacierTransitionPeriodInDays: !Ref 'GlacierTransitionPeriodInDays'
        IATransitionPeriodInDays: !Ref 'IATransitionPeriodInDays'
        KinesisStreamsShardsCount: !Ref 'KinesisStreamsShardsCount'
        LicensedSoftwareS3BucketName: !Ref LicensedSoftwareS3BucketName
        LogGroupNamePrefix: !Ref 'LogGroupNamePrefix'
        MaxIndexAge: !Ref 'MaxIndexAge'
        MetricNamespaceNamePrefix: !Ref 'MetricNamespaceNamePrefix'
        MQTTTopicPrefix: !Sub '${PIServerIP}-${QSDeploymentSuffix}'
        IoTMetricNamespacePrefix: !Ref 'IoTMetricNamespacePrefix'
        IoTCreateIndividualLogs: !Ref 'IoTCreateIndividualLogs'
        PrivateSubnet1ID: !Ref 'PrivateSubnet1ID'
        PrivateSubnet2ID: !Ref 'PrivateSubnet2ID'
        PublicSubnet1ID: !Ref 'PublicSubnet1ID'
        PublicSubnet2ID: !Ref 'PublicSubnet2ID'
        QSDeploymentSuffix: !Ref 'QSDeploymentSuffix'
        QSS3BucketName: !Ref 'QSS3BucketName'
        QSS3KeyPrefix: !Ref 'QSS3KeyPrefix'
        RemoteAccessCIDR: !Ref 'RemoteAccessCIDR'
        VPCCIDR: !Ref 'VPCCIDR'
        VPCID: !Ref 'VPCID'
        RDSInstanceType: !Ref 'RDSInstanceType'
        RDSPassword: !Ref 'RDSPassword'
        RDSUsername: !Ref 'RDSUsername'
        ManagementConsoleDockerTag: !Ref ManagementConsoleDockerTag
        ApiInstanceDockerTag: !Ref ApiInstanceDockerTag
        MosquittoBrokerDockerTag: !Ref MosquittoBrokerDockerTag
        UseCustomDockerRepository: !Ref UseCustomDockerRepository
      TemplateURL: !Sub 'https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/foundation/industrial-data-connector.template'
    Type: AWS::CloudFormation::Stack
Outputs:
  ManagementConsoleURL:
    Value: !GetAtt 'IDCFoundationStack.Outputs.ManagementConsoleURL'
    Description: Management Console URL
  APIURL:
    Value: !GetAtt 'IDCFoundationStack.Outputs.APIURL'
    Description: API URL
  ElasticsearchEndpoint:
    Value: !GetAtt 'IDCFoundationStack.Outputs.ElasticsearchDomainEndpoint'
    Description: Elasticsearch domain endpoint
  CuratedBucketName:
    Value: !GetAtt 'IDCFoundationStack.Outputs.CuratedDataBucketName'
    Description: Bucket name for Curated Datasets
  PublishedBucketName:
    Value: !GetAtt 'IDCFoundationStack.Outputs.PublishedDataBucketName'
    Description: Bucket name for Published Data
  SubmissionsBucketName:
    Value: !GetAtt 'IDCFoundationStack.Outputs.SubmissionsBucketName'
    Description: Bucket name for submissions
  KinesisStreamName:
    Value: !If
      - UseKinesis
      - !GetAtt 'IDCFoundationStack.Outputs.KinesisStreamName'
      - ''
    Description: Kinesis feeds data stream name
